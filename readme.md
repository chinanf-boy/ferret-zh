# MontFerret/ferret [![explain]][source] [![translate-svg]][translate-list]

<!-- [![size-img]][size] -->

[explain]: http://llever.com/explain.svg
[source]: https://github.com/chinanf-boy/Source-Explain
[translate-svg]: http://llever.com/translate.svg
[translate-list]: https://github.com/chinanf-boy/chinese-translate-list
[size-img]: https://packagephobia.now.sh/badge?p=Name
[size]: https://packagephobia.now.sh/result?p=Name

ã€Œ `ferret`æ˜¯ä¸€ä¸ªç½‘ç»œæŠ“å–ç³»ç»Ÿã€‚ ã€

[ä¸­æ–‡](./readme.md) | [english](https://github.com/MontFerret/ferret)

---

## æ ¡å¯¹ âœ…

<!-- doc-templite START generated -->
<!-- repo = 'MontFerret/ferret' -->
<!-- commit = '88188cac2c0c603d24377cd2b321f7cf9a2991e5' -->
<!-- time = '2018-10-11' -->

| ç¿»è¯‘çš„åŸæ–‡ | ä¸æ—¥æœŸ        | æœ€æ–°æ›´æ–° | æ›´å¤š                       |
| ---------- | ------------- | -------- | -------------------------- |
| [commit]   | â° 2018-10-11 | ![last]  | [ä¸­æ–‡ç¿»è¯‘][translate-list] |

[last]: https://img.shields.io/github/last-commit/MontFerret/ferret.svg
[commit]: https://github.com/MontFerret/ferret/tree/88188cac2c0c603d24377cd2b321f7cf9a2991e5

<!-- doc-templite END generated -->

### è´¡çŒ®

æ¬¢è¿ ğŸ‘ å‹˜è¯¯/æ ¡å¯¹/æ›´æ–°è´¡çŒ® ğŸ˜Š [å…·ä½“è´¡çŒ®è¯·çœ‹](https://github.com/chinanf-boy/chinese-translate-list#è´¡çŒ®)

## ç”Ÿæ´»

[help me live , live need money ğŸ’°](https://github.com/chinanf-boy/live-need-money)

---

### ç›®å½•

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [ferret](#ferret)
  - [å®ƒæ˜¯ä»€ä¹ˆ?](#%E5%AE%83%E6%98%AF%E4%BB%80%E4%B9%88)
  - [ç»™æˆ‘çœ‹ä¸€äº›ä»£ç ](#%E7%BB%99%E6%88%91%E7%9C%8B%E4%B8%80%E4%BA%9B%E4%BB%A3%E7%A0%81)
  - [ç‰¹æ€§](#%E7%89%B9%E6%80%A7)
  - [åŠ¨æœº](#%E5%8A%A8%E6%9C%BA)
  - [çµæ„Ÿ](#%E7%81%B5%E6%84%9F)
  - [WIP](#wip)
  - [å®‰è£…](#%E5%AE%89%E8%A3%85)
    - [å…ˆå†³æ¡ä»¶](#%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6)
      - [ç”Ÿäº§](#%E7%94%9F%E4%BA%A7)
      - [å‘å±•](#%E5%8F%91%E5%B1%95)
  - [å¿«é€Ÿå¼€å§‹](#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B)
    - [æ— æµè§ˆå™¨æ¨¡å¼](#%E6%97%A0%E6%B5%8F%E8%A7%88%E5%99%A8%E6%A8%A1%E5%BC%8F)
    - [æµè§ˆå™¨æ¨¡å¼](#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%A8%A1%E5%BC%8F)
    - [åµŒå…¥æ¨¡å¼](#%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%BC%8F)
  - [å¯æ‰©å±•æ€§](#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# ferret

[![Build Status](https://travis-ci.com/MontFerret/ferret.svg?branch=master)](https://travis-ci.com/MontFerret/ferret)\
![ferret](https://raw.githubusercontent.com/MontFerret/ferret/master/assets/intro.jpg)

## å®ƒæ˜¯ä»€ä¹ˆ?

`ferret`æ˜¯ä¸€ä¸ªç½‘ç»œæŠ“å–ç³»ç»Ÿï¼Œæ—¨åœ¨ç®€åŒ–ç½‘ç»œä¸Šçš„æ•°æ®æå–ï¼Œç”¨äº UI æµ‹è¯•ï¼Œæœºå™¨å­¦ä¹ å’Œåˆ†æç­‰.\
æ‹¥æœ‰è‡ªå·±çš„å£°æ˜æ€§è¯­è¨€ï¼Œ`ferret`æŠ½è±¡å‡ºæŠ€æœ¯ç»†èŠ‚å’Œåº•å±‚æŠ€æœ¯çš„å¤æ‚æ€§ï¼Œå¸®åŠ©å…³æ³¨æ•°æ®æœ¬èº«.\
å®ƒéå¸¸ä¾¿æº,å¯æ‰©å±•ä¸”å¿«é€Ÿ.

## ç»™æˆ‘çœ‹ä¸€äº›ä»£ç 

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†åŠ¨æ€é¡µé¢çš„ä½¿ç”¨.\
é¦–å…ˆ,æˆ‘ä»¬åŠ è½½ä¸» Google æœç´¢é¡µé¢,åœ¨è¾“å…¥æ¡†ä¸­ï¼Œé”®å…¥æœç´¢æ¡ä»¶,ç„¶åå•å‡»æœç´¢æŒ‰é’®.\
ç‚¹å‡»æ“ä½œä¼šè§¦å‘é‡å®šå‘,å› æ­¤æˆ‘ä»¬ä¼šç­‰åˆ°å®ƒç»“æŸ.\
é¡µé¢åŠ è½½å,æˆ‘ä»¬è¿­ä»£æœç´¢ç»“æœä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå¹¶å°†è¾“å‡ºåˆ†é…ç»™å˜é‡.\
æœ€åçš„ for å¾ªç¯ä¼šè¿‡æ»¤æ‰ï¼Œå¯èƒ½å› ä½¿ç”¨ä¸å‡†ç¡®é€‰æ‹©å™¨è€Œå¯¼è‡´çš„ç©ºå…ƒç´ .

```aql
LET google = DOCUMENT("https://www.google.com/", true)

INPUT(google, 'input[name="q"]', "ferret", 25)
CLICK(google, 'input[name="btnK"]')

WAIT_NAVIGATION(google)

FOR result IN ELEMENTS(google, '.g')
    // è¿‡æ»¤videos å’Œ 'People also ask'ç­‰çš„é¢å¤–å…ƒç´ 
    FILTER TRIM(result.attributes.class) == 'g'
    RETURN {
        title: INNER_TEXT(result, 'h3'),
        description: INNER_TEXT(result, '.st'),
        url: INNER_TEXT(result, 'cite')
    }
```

æ‚¨å¯ä»¥æ‰¾åˆ°æ›´å¤šç¤ºä¾‹[è¿™é‡Œ](https://github.com/MontFerret/ferret/blob/master/examples)

## ç‰¹æ€§

- é™ˆè¿°æ€§è¯­è¨€
- æ”¯æŒé™æ€å’ŒåŠ¨æ€ç½‘é¡µ
- åµŒå…¥å¼
- å¯æ‰©å±•

## åŠ¨æœº

å¦‚ä»Šæ•°æ®å°±æ˜¯ä¸€åˆ‡,è°æ‹¥æœ‰æ•°æ® - æ‹¥æœ‰ä¸–ç•Œ.\
æˆ‘å‚ä¸äº†å¤šä¸ªæ•°æ®é©±åŠ¨çš„é¡¹ç›®,å…¶ä¸­æ•°æ®æ˜¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†,æˆ‘æ„è¯†åˆ°ç¼–å†™å¤§é‡çš„åˆ®åˆ€(çˆ¬è™«)æ˜¯å¤šä¹ˆç¹ç.\
ç»è¿‡ä¸€æ®µæ—¶é—´å¯»æ‰¾ä¸€ä¸ªï¼Œè®©æˆ‘ä¸å†ç¼–å†™ä»£ç çš„å·¥å…·ï¼Œä»…ä»…ç»™å‡ºæˆ‘éœ€è¦çš„æ•°æ®,è¿™æ—¶æˆ‘å†³å®šæå‡ºæˆ‘è‡ªå·±çš„è§£å†³æ–¹æ¡ˆ.\
`ferret`é¡¹ç›®æ˜¯ä¸€é¡¹é›„å¿ƒå‹ƒå‹ƒçš„è®¡åˆ’,æ—¨åœ¨ä¸ºé€šç”¨å¹³å°ï¼Œä¸è´¹å¹ç°ä¹‹åŠ›ç¼–å†™åˆ®åˆ€ã€‚

## çµæ„Ÿ

FQL(FerretæŸ¥è¯¢è¯­è¨€)å—åˆ°äº†[AQL](https://www.arangodb.com/)(ArangoDB æŸ¥è¯¢è¯­è¨€)å¾ˆå¤§çš„å¯å‘.\
ä½†ç”±äºåŸŸåå…·ä½“,åœ¨å·¥ä½œæ–¹å¼ä¸Š,å­˜åœ¨ä¸€äº›å·®å¼‚.

## WIP

è¯·æ³¨æ„,è¯¥é¡¹ç›®æ­£åœ¨å¤§åŠ›å‘å±•ã€‚æš‚æ—¶æ²¡æœ‰æ–‡æ¡£,ä¸”æœ€ç»ˆç‰ˆæœ¬ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›å˜åŒ–.\
å¯¹äºæŸ¥è¯¢è¯­æ³•,æ‚¨å¯ä»¥è½¬åˆ°[ArangoDB ç½‘ç«™](https://docs.arangodb.com/3.3/AQL/index.html)å¹¶ï¼Œä½¿ç”¨ AQL æ–‡æ¡£ä½œä¸º FQL çš„æ–‡æ¡£ - å› ä¸ºå®ƒä»¬æ˜¯ç›¸åŒçš„.

## å®‰è£…

### å…ˆå†³æ¡ä»¶

#### ç”Ÿäº§

- Go >= 1.9
- Chrome æˆ– Docker

#### å‘å±•

- GoDep
- GNU Make
- ANTLR4 >= 4.7.1

```sh
go get github.com/MontFerret/ferret
```

æ‚¨å¯ä»¥ä½¿ç”¨ Google Chrome / Chromium çš„æœ¬åœ°å‰¯æœ¬,ä½†ä¸ºäº†ä¾¿äºä½¿ç”¨,å»ºè®®æ‚¨åœ¨ Docker å®¹å™¨ä¸­ï¼Œè¿è¡Œå®ƒ:

```sh
docker pull alpeware/chrome-headless-trunk
docker run -d -p=0.0.0.0:9222:9222 --name=chrome-headless -v /tmp/chromedata/:/data alpeware/chrome-headless-trunk
```

ä½†æ˜¯,å¦‚æœæ‚¨æƒ³æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„æƒ…å†µ,åªéœ€ä»¥è¿œç¨‹è°ƒè¯•ç«¯å£å¯åŠ¨ Chrome:

```sh
chrome.exe --remote-debugging-port=9222
```

## å¿«é€Ÿå¼€å§‹

### æ— æµè§ˆå™¨æ¨¡å¼

å¦‚æœä½ æƒ³ç©`fql`ï¼Œå¹¶æ£€æŸ¥å…¶è¯­æ³•,æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ CLI:

```
ferret
```

`ferret`å°†ä»¥ REPL æ¨¡å¼è¿è¡Œ.

```shell
Welcome to Ferret REPL
Please use `Ctrl-D` to exit this program.
>%
>LET doc = DOCUMENT('https://news.ycombinator.com/')
>FOR post IN ELEMENTS(doc, '.storylink')
>RETURN post.attributes.href
>%
```

**æ³¨æ„:**ç¬¦å·`%`ç”¨äºå¯åŠ¨ï¼Œå’Œç»“æŸå¤šè¡ŒæŸ¥è¯¢ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ heredoc æ ¼å¼.

å¦‚æœè¦æ‰§è¡Œå­˜å‚¨åœ¨æ–‡ä»¶ä¸­çš„æŸ¥è¯¢,åªéœ€ä¼ é€’æ–‡ä»¶å:

```
ferret ./docs/examples/static-page.fql
```

```
cat ./docs/examples/static-page.fql | ferret
```

```
ferret < ./docs/examples/static-page.fql
```

### æµè§ˆå™¨æ¨¡å¼

é»˜è®¤æƒ…å†µä¸‹,`ferret`é€šè¿‡ HTTP åè®®åŠ è½½ HTML é¡µé¢,å› ä¸ºå®ƒæ›´å¿«.\
ä½†æ˜¯ç°åœ¨,æœ‰è¶Šæ¥è¶Šå¤šçš„ç½‘ç«™ä½¿ç”¨ JavaScript è¿›è¡Œæ¸²æŸ“,å› æ­¤,è¿™ç§"è€æ´¾"æ–¹æ³•ï¼Œå¸¸å¸¸å¹¶æ²¡æœ‰çœŸæ­£èµ·ä½œç”¨ã€‚\
å¯¹äºè¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥é€šè¿‡ Chrome DevTools åè®®(ä¹Ÿç§°ä¸º CDP)ä½¿ç”¨ Chrome æˆ– Chromium è·å–æ–‡æ¡£é¡µé¢.\
é¦–å…ˆ,æ‚¨éœ€è¦ç¡®ä¿å·²å¯åŠ¨ Chrome çš„`remote-debugging-port=9222`å‚æ•°.\
å…¶æ¬¡,æ‚¨éœ€è¦å°†åœ°å€ä¼ é€’ç»™`ferret`CLI.

```
ferret --cdp http://127.0.0.1:9222
```

**æ³¨æ„:**é»˜è®¤æƒ…å†µä¸‹,`ferret`ä»¥è¿™ä¸ªæœ¬åœ°åœ°å€ï¼Œä½œä¸ºé»˜è®¤åœ°å€,å› æ­¤åœ¨ä¸åŒç«¯å£å·æˆ–è¿œç¨‹åœ°å€çš„æƒ…å†µä¸‹ï¼Œæ‰ç”¨æ˜¾å¼ä¼ é€’å‚æ•°.

æˆ–è€…,æ‚¨å¯ä»¥å‘Šè¯‰ CLI ä¸ºæ‚¨å¯åŠ¨ Chrome.

```shell
ferret --cdp-launch
```

**æ³¨æ„:**MacOS ä¸Šçš„å¯åŠ¨å‘½ä»¤ï¼Œç›®å‰å·²è¢«ç ´å.

ä¸€æ—¦`ferret`çŸ¥é“å¦‚ä½•ä¸ Chrome é€šä¿¡,æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ª`DOCUMENT(url, isDynamic)`å‡½æ•°ï¼Œç”¨å¸ƒå°”å€¼`true`è¡¨æ˜isDynamicæ˜¯å¦åŠ¨æ€é¡µé¢:

```shell
Welcome to Ferret REPL
Please use `exit` or `Ctrl-D` to exit this program.
>%
>LET doc = DOCUMENT('https://soundcloud.com/charts/top', true)
>WAIT_ELEMENT(doc, '.chartTrack__details', 5000)
>LET tracks = ELEMENTS(doc, '.chartTrack__details')
>FOR track IN tracks
>    LET username = ELEMENT(track, '.chartTrack__username')
>    LET title = ELEMENT(track, '.chartTrack__title')
>    RETURN {
>       artist: username.innerText,
>        track: title.innerText
>    }
>%
```

```shell
Welcome to Ferret REPL
Please use `exit` or `Ctrl-D` to exit this program.
>%
>LET doc = DOCUMENT("https://github.com/", true)
>LET btn = ELEMENT(doc, ".HeaderMenu a")

>CLICK(btn)
>WAIT_NAVIGATION(doc)
>WAIT_ELEMENT(doc, '.IconNav')

>FOR el IN ELEMENTS(doc, '.IconNav a')
>    RETURN TRIM(el.innerText)
>%
```

### åµŒå…¥æ¨¡å¼

`ferret`æ˜¯ä¸€ä¸ªæ³¨é‡æ¨¡å—åŒ–çš„ç³»ç»Ÿ,å› æ­¤,å¯ä»¥è½»æ¾åµŒå…¥åˆ°æ‚¨çš„ Go åº”ç”¨ç¨‹åºä¸­.

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/MontFerret/ferret/pkg/compiler"
	"os"
)

type Topic struct {
	Name        string `json:"name"`
	Description string `json:"description"`
	Url         string `json:"url"`
}

func main() {
	topics, err := getTopTenTrendingTopics()

	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	for _, topic := range topics {
		fmt.Println(fmt.Sprintf("%s: %s %s", topic.Name, topic.Description, topic.Url))
	}
}

func getTopTenTrendingTopics() ([]*Topic, error) {
	query := `
		LET doc = DOCUMENT("https://github.com/topics")

		FOR el IN ELEMENTS(doc, ".py-4.border-bottom")
			LIMIT 10
			LET url = ELEMENT(el, "a")
			LET name = ELEMENT(el, ".f3")
			LET desc = ELEMENT(el, ".f5")

			RETURN {
				name: TRIM(name.innerText),
				description: TRIM(desc.innerText),
				url: "https://github.com" + url.attributes.href
			}
	`

	comp := compiler.New()

	program, err := comp.Compile(query)

	if err != nil {
		return nil, err
	}

	out, err := program.Run(context.Background())

	if err != nil {
		return nil, err
	}

	res := make([]*Topic, 0, 10)

	err = json.Unmarshal(out, &res)

	if err != nil {
		return nil, err
	}

	return res, nil
}
```

## å¯æ‰©å±•æ€§

åŒæ ·çš„,`ferret`æ›´æ˜¯ä¸€ä¸ªæ³¨é‡æ¨¡å—åŒ–çš„ç³»ç»Ÿ,å®ƒä¸ä»…å¯ä»¥åµŒå…¥å®ƒ,è¿˜å¯ä»¥æ‰©å±•å…¶æ ‡å‡†åº“.

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/MontFerret/ferret/pkg/compiler"
	"github.com/MontFerret/ferret/pkg/runtime/core"
	"github.com/MontFerret/ferret/pkg/runtime/values"
	"os"
)

func main() {
	strs, err := getStrings()

	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	for _, str := range strs {
		fmt.Println(str)
	}
}

func getStrings() ([]string, error) {
	// æ­¤å‡½æ•°å®ç°äº†ä¸€ç§å‡½æ•°ç±»å‹ï¼Œè€Œferretæ”¯æŒè¯¥å‡½æ•°ä½œä¸ºè¿è¡Œæ—¶å‡½æ•°
	transform := func(ctx context.Context, args ...core.Value) (core.Value, error) {
		// å®ƒåªæ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œæœ‰åŠ©äºéªŒè¯ä¸€äº›ä¼ é€’çš„args
		err := core.ValidateArgs(args, 1)

		if err != nil {
			// å»ºè®®è¿”å›å†…ç½®çš„Noneç±»å‹ï¼Œè€Œä¸æ˜¯nil
			return values.None, err
		}

		// è¿™æ˜¯å¦ä¸€ä¸ªå…è®¸è¿›è¡Œç±»å‹éªŒè¯çš„è¾…åŠ©å‡½æ•°
		err = core.ValidateType(args[0], core.StringType)

		if err != nil {
			return values.None, err
		}

		// å¼ºåˆ¶è½¬æ¢ä¸ºå†…ç½®å­—ç¬¦ä¸²ç±»å‹
		str := args[0].(values.String)

		return str.Concat(values.NewString("_ferret")).ToUpper(), nil
	}

	query := `
		FOR el IN ["foo", "bar", "qaz"]
			// é€šå¸¸ï¼Œæ‰€æœ‰å‡½æ•°éƒ½ä»¥å¤§å†™å½¢å¼æ³¨å†Œ
			RETURN TRANSFORM(el)
	`

	comp := compiler.New()
	comp.RegisterFunction("transform", transform)

	program, err := comp.Compile(query)

	if err != nil {
		return nil, err
	}

	out, err := program.Run(context.Background())

	if err != nil {
		return nil, err
	}

	res := make([]string, 0, 3)

	err = json.Unmarshal(out, &res)

	if err != nil {
		return nil, err
	}

	return res, nil
}
```

æœ€é‡è¦çš„æ˜¯,æ‚¨å¯ä»¥ç»•è¿‡ä»¥ä¸‹é€‰é¡¹ï¼Œå®Œå…¨å…³é—­æ ‡å‡†åº“:

```go
comp := compiler.New(compiler.WithoutStdlib())
```

ä¹‹å,æ‚¨å¯ä»¥è½»æ¾åœ°ä»æ ‡å‡†åº“ä¸­ï¼Œæä¾›è‡ªå·±çš„å‡½æ•°å®ç°.

å¦‚æœæ‚¨ä¸éœ€è¦æ ‡å‡†åº“ä¸­çš„ç‰¹å®šå‡½æ•°é›†,åˆ™å¯ä»¥å…³é—­æ•´ä¸ª`stdlib`å‡½æ•°ï¼Œå¹¶æ³¨å†Œå…¶ä»–å•ç‹¬çš„åŒ…:

```go
package main

import (
    "github.com/MontFerret/ferret/pkg/compiler"
    "github.com/MontFerret/ferret/pkg/stdlib/strings"
)

func main() {
    comp := compiler.New(compiler.WithoutStdlib())

    comp.RegisterFunctions(strings.NewLib())
}
```
